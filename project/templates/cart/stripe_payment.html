{% extends 'nav.html' %}
{% block content %}
<div class="container">
    <h2 class="text-center my-4">Stripe Payment</h2>
    <p>Total Amount: Rs.{{ total_amount }}</p>
    <div id="card-element" class="my-4"></div>
    <div id="card-errors" role="alert" style="color: red;"></div>
    <form action="{% url 'stripe_payment' %}" method="POST" id="payment-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary mt-3">Pay Rs.{{ total_amount }}</button>
    </form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}'); // Use your publishable key
    const elements = stripe.elements();
    const card = elements.create('card'); // Create the card element
    card.mount('#card-element'); // Mount the card element

    // Handle form submission
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const { paymentMethod, error } = await stripe.createPaymentMethod({
            type: 'card',
            card: card,
        });

        if (error) {
            document.getElementById('card-errors').textContent = error.message;
        } else {
            // Append payment method ID to form and submit
            const hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'payment_method_id');
            hiddenInput.setAttribute('value', paymentMethod.id);
            form.appendChild(hiddenInput);
            form.submit();
        }
    });
</script>
{% endblock %}
